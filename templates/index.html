<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BMW Failures Summary</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f4f7f6;
    text-align: center;
    padding: 20px;
}
.container {
    max-width: 90%;
    margin: auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
}
label {
    margin-right: 5px;
    font-weight: bold;
    color: #333;
}
select.styled-select, input[type="date"].styled-date {
    margin: 5px;
    padding: 8px 12px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #fdfaf6;
    color: #333;
    transition: border-color 0.3s ease, box-shadow 0.2s ease;
}
select.styled-select:focus, input[type="date"].styled-date:focus {
    outline: none;
    border-color: #C77B55;
    box-shadow: 0 0 5px rgba(199, 123, 85, 0.4);
}
#chartContainer {
    width: 80%;
    margin: 20px auto;
    position: relative;
    height: 400px;
}
canvas {
    max-width: 100%;
    height: auto;
}
table {
    margin: 20px auto;
    width: 90%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
}
th {
    background: #eee;
}
td.station-clickable {
    cursor: pointer;
    transition: background-color 0.3s ease;
}
td.station-clickable:hover {
    background-color: #eef;
}
button.fixture-button {
    background-color: #C77B55;
    color: #fff;
    border: none;
    padding: 10px 20px;
    margin-top: 10px;
    margin-bottom: 20px;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
}
button.fixture-button:hover {
    background-color: #9B5E4A;
    transform: translateY(-1px);
}
button.fixture-button:active {
    background-color: #7D4A3B;
    transform: translateY(1px);
}
.status-message {
    font-style: italic;
    color: #666;
    margin-top: 10px;
}
</style>
</head>
<body>

<div class="container">
    <h2>BMW Failures Summary</h2>

    <label for="lineIdSelect">Line:</label>
    <select id="lineIdSelect" class="styled-select">
        <option value="BMA01">BMA01</option>
        <option value="B3">B3</option>
    </select>

    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate" class="styled-date" />

    <label for="endDate">End Date:</label>
    <input type="date" id="endDate" class="styled-date" />

    <button id="fixtureButton" class="fixture-button">View Fixture Details</button>

    <div id="chartContainer">
        <canvas id="failuresChart"></canvas>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <h3>Summary Table</h3>
    <table>
        <thead>
            <tr>
                <th>Work Date</th>
                <th>VFlash1</th>
                <th>Hipot1</th>
                <th>ATS1</th>
                <th>Heatup</th>
                <th>Vibration</th>
                <th>Burn-in</th>
                <th>Hipot2</th>
                <th>ATS2</th>
                <th>VFlash2</th>
                <th>ATS3</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="12">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
(() => {
    const stationColors = {
        'VFlash1': '#C77B55',
        'Hipot1':  '#7D8B63',
        'ATS1':    '#D6C6B8',
        'Heatup':  '#A6A57A',
        'Vibration': '#6C7A89',
        'Burn-in': '#BCA875',
        'Hipot2':  '#4B4B4B',
        'ATS2':    '#9B5E4A',
        'VFlash2': '#D9D9D9',
        'ATS3':    '#C4A69F'
    };

    const stationMap = {
        "VFlash1": "%LASH",
        "Hipot1": "%IPOT_1",
        "ATS1": "%TS1",
        "Heatup": "%TUP",
        "Vibration": "%RATION",
        "Burn-in": "%RN_IN",
        "Hipot2": "%IPOT_2",
        "ATS2": "%TS2",
        "VFlash2": "%LASH2",
        "ATS3": "%TS3"
    };

    const lineIdSelect = document.getElementById('lineIdSelect');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const tableBody = document.getElementById('tableBody');
    const statusMessage = document.getElementById('statusMessage');
    const ctx = document.getElementById('failuresChart').getContext('2d');
    const fixtureButton = document.getElementById('fixtureButton');

    let ws = null;
    let chart = null;
    let currentLineId = lineIdSelect.value;

    function saveState() {
        sessionStorage.setItem("lineId", lineIdSelect.value);
        sessionStorage.setItem("startDate", startDateInput.value);
        sessionStorage.setItem("endDate", endDateInput.value);
    }

    function restoreState() {
        const savedLineId = sessionStorage.getItem("lineId");
        const savedStartDate = sessionStorage.getItem("startDate");
        const savedEndDate = sessionStorage.getItem("endDate");
        const today = new Date().toISOString().split('T')[0];

        lineIdSelect.value = savedLineId || "BMA01";
        startDateInput.value = savedStartDate || today;
        endDateInput.value = savedEndDate || today;
    }

    function navigateToPage(pageName, lineId, stationName, workDate) {
        saveState();
        const timestamp = Date.now();
        const url = `${pageName}.html?lineId=${lineId}&station=${encodeURIComponent(stationName)}&workDate=${workDate}&_ts=${timestamp}`;
        window.location.href = url;
    }

    function clearTable() {
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }
    }

    function addTableRow(html) {
        const tr = document.createElement('tr');
        tr.innerHTML = html;
        tableBody.appendChild(tr);
    }

    function renderChart(data) {
        const labels = data.map(row => row.workDate);
        const stationKeys = Object.keys(stationMap);

        const datasets = stationKeys.map(station => ({
            label: station,
            data: data.map(row => row[station.toLowerCase()]),
            backgroundColor: stationColors[station],
            borderColor: stationColors[station],
            borderWidth: 1
        }));

        // ðŸ”· destroy old chart
        if (chart) {
            chart.destroy();
            chart = null;
        }

        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const element = elements[0];
                        const station = stationKeys[element.datasetIndex];
                        const mapped = stationMap[station];
                        const workDate = data[element.index].workDate;
                        if (mapped && workDate) {
                            navigateToPage('station-detail', currentLineId, mapped, workDate);
                        } else {
                            alert("No data for this point.");
                        }
                    }
                },
                scales: {
                    x: { stacked: true, title: { display: true, text: "Date" } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: "Failures" } }
                }
            }
        });
    }

    function renderTable(data) {
        clearTable();

        if (!data.length) {
            addTableRow('<td colspan="12">No data available</td>');
            return;
        }

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.appendChild(createCell(row.workDate));

            ['vflash1', 'hipot1', 'ats1', 'heatup', 'vibration', 'burnin', 'hipot2', 'ats2', 'vflash2', 'ats3'].forEach((key, idx) => {
                const val = row[key];
                const stationKey = Object.keys(stationMap)[idx];
                const td = createCell(val);
                if (val > 0) {
                    td.classList.add('station-clickable');
                    td.addEventListener('click', () => {
                        navigateToPage('station-detail', currentLineId, stationMap[stationKey], row.workDate);
                    });
                }
                tr.appendChild(td);
            });

            tr.appendChild(createCell(row.total));
            tableBody.appendChild(tr);
        });
    }

    function createCell(text) {
        const td = document.createElement('td');
        td.textContent = text;
        return td;
    }

    function reloadData() {
        if (ws) ws.close();

        // ðŸ”· destroy old chart
        if (chart) {
            chart.destroy();
            chart = null;
        }

        currentLineId = lineIdSelect.value;
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const ts = Date.now();

        if (!currentLineId) {
            statusMessage.textContent = "Please select a valid line.";
            return;
        }
        if (!startDate) {
            statusMessage.textContent = "Please select a start date.";
            return;
        }
        if (!endDate) {
            statusMessage.textContent = "Please select an end date.";
            return;
        }
        if (startDate > endDate) {
            statusMessage.textContent = "Start date cannot be after end date.";
            return;
        }

        statusMessage.textContent = "Connecting to data source...";

        let wsUrl = `ws://localhost:8000/failures/ws/filter?lineId=${encodeURIComponent(currentLineId)}&_ts=${ts}`;
        wsUrl += `&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            clearTable();
            addTableRow('<td colspan="12">Loading data...</td>');
            statusMessage.textContent = "Loading data...";
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);

                if (!Array.isArray(data) || data.length === 0) {
                    clearTable();
                    addTableRow('<td colspan="12">No data available for the selected criteria.</td>');
                    statusMessage.textContent = "No data available.";
                    return;
                }

                renderChart(data);
                renderTable(data);
                statusMessage.textContent = "";
            } catch (err) {
                console.error("Failed to parse data:", err);
                statusMessage.textContent = "Error: Received invalid data.";
            }
        };

        ws.onclose = () => {
            console.log("WebSocket connection closed.");
            if (!statusMessage.textContent) {
                statusMessage.textContent = "Connection closed.";
            }
        };

        ws.onerror = (err) => {
            console.error("WebSocket error:", err);
            statusMessage.textContent = "Error: Could not connect to data source.";
        };
    }

    fixtureButton.addEventListener('click', () => {
        saveState();
        const lineId = lineIdSelect.value;
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        if (!lineId || !startDate || !endDate) {
            alert("Please select Line, Start Date, and End Date before viewing fixture details.");
            return;
        }

        const url = `fixture-detail.html?lineId=${encodeURIComponent(lineId)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;
        window.location.href = url;
    });

    document.addEventListener("DOMContentLoaded", () => {
        restoreState();
        reloadData();

        [lineIdSelect, startDateInput, endDateInput].forEach(el => {
            el.addEventListener('change', () => {
                saveState();
                reloadData();
            });
        });
    });
})();
</script>


</body>
</html>
