<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BMW Failures Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 20px;
    background-color: #f4f7f6;
    color: #333;
}
h2 {
    color: #2c3e50;
    margin-bottom: 25px;
}
.container {
    max-width: 90%;
    margin: 0 auto;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
label {
    font-weight: bold;
    margin-right: 10px;
    color: #555;
}
select {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
    margin-bottom: 20px;
    cursor: pointer;
}
#chartContainer {
    width: 80%;
    margin: 20px auto;
    position: relative;
    height: 400px;
}
canvas {
    max-width: 100%;
    height: auto;
}
table {
    margin: 30px auto;
    border-collapse: collapse;
    width: 90%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}
th, td {
    border: 1px solid #e0e0e0;
    padding: 12px 15px;
    text-align: center;
    font-size: 15px;
}
th {
    background-color: #e9ecef;
    font-weight: bold;
    color: #333;
}
tr:nth-child(even) {
    background-color: #f8f9fa;
}
tr:hover {
    background-color: #e2f4e8;
}
/* New style for the detail button */
.detail-button {
    background-color: #28a745; /* Green color */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 20px;
    margin-left: 10px; /* Add some space if next to other elements */
    transition: background-color 0.3s ease;
}
.detail-button:hover {
    background-color: #218838; /* Darker green on hover */
}
</style>
</head>
<body>

<div class="container">
    <h2>BMW Failures Summary (Today)</h2>

    <label for="lineIdSelect">Select Line ID:</label>
    <select id="lineIdSelect">
        <option value="B3">B3</option>
        <option value="BMA01">BMA01</option>
    </select>

    <button class="detail-button" onclick="navigateToPage('fixture-detail', currentLineId, 'Fixture')">View Fixture Details</button>

    <div id="chartContainer">
        <canvas id="failuresChart"></canvas>
    </div>

    <h3>Summary Details</h3>
    <table>
        <thead>
            <tr>
                <th>Work Date</th>
                <th>VFlash1</th>
                <th>Hipot1</th>
                <th>ATS1</th>
                <th>Heatup</th>
                <th>Vibration</th>
                <th>Burn-in</th>
                <th>Hipot2</th>
                <th>ATS2</th>
                <th>VFlash2</th>
                <th>ATS3</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="resultTableBody">
            <tr><td colspan="12">Loading data...</td></tr>
        </tbody>
    </table>
</div>

<script>
const lineIdSelect = document.getElementById('lineIdSelect');
const ctx = document.getElementById('failuresChart').getContext('2d');
const tbody = document.getElementById('resultTableBody');

let ws = null;
let chart = null;
let currentLineId = lineIdSelect.value;

// Centralized function to get query parameters from the URL
function getQueryParams() {
    const params = {};
    window.location.search.substring(1).split('&').forEach(param => {
        const parts = param.split('=');
        if (parts.length === 2) {
            params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1].replace(/\+/g, ' '));
        }
    });
    return params;
}

// Centralized function for navigating between pages
function navigateToPage(pageName, lineId, stationName = null) {
    // Generate a unique timestamp for cache busting
    const timestamp = new Date().getTime();
    let url = `${pageName}.html?lineId=${lineId}&_ts=${timestamp}`;

    // Add stationName if provided, for potential future use in detail pages
    if (stationName) {
        url += `&station=${stationName}`;
    }

    window.location.href = url;
}

// Flexible function to start WebSocket connection
function startWebSocket(lineId, endpointPath) {
    if (ws) {
        ws.close();
        console.log(`ℹ️ Previous WebSocket (${ws.url}) closed.`);
    }

    currentLineId = lineId;
    const timestamp = new Date().getTime(); // Generate new timestamp for each new connection

    // Construct WebSocket URL with cache busting timestamp
    const wsUrl = `ws://localhost:8000/failures/ws/${endpointPath}?lineId=${lineId}&_ts=${timestamp}`;
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        console.log(`✅ WebSocket opened to ${wsUrl}`);
        // Adjusted colspan for the loading message to match the new table header
        tbody.innerHTML = '<tr><td colspan="12">Waiting for data...</td></tr>';
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log(`Received data from ${wsUrl}:`, data);

        if (!data || data.length === 0) {
            console.warn(`⚠️ No data received or data is empty for ${endpointPath}.`);
            tbody.innerHTML = '<tr><td colspan="12">No data available.</td></tr>'; // Adjusted colspan
            if (chart) chart.destroy();
            chart = null;
            return;
        }

        // This page always expects summary data (an array with one object for today)
        updateChart(data[0]);
        updateTable(data[0]);
    };

    ws.onclose = () => {
        console.log(`❌ WebSocket closed from ${ws.url}`);
    };

    ws.onerror = (err) => {
        console.error(`❗ WebSocket error from ${ws.url}:`, err);
    };
}

function updateChart(row) {
    const labels = ["VFlash1", "Hipot1", "ATS1", "Heatup", "Vibration", "Burn-in", "Hipot2", "ATS2", "VFlash2", "ATS3"];
    const values = [
        row.vflash1, row.hipot1, row.ats1,
        row.heatup, row.vibration, row.burnin, row.hipot2,
        row.ats2, row.vflash2, row.ats3
    ];

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: `Failures on ${row.workDate}`,
                    data: values,
                    backgroundColor: 'rgb(242,237,215,0.7)',
                    borderColor: 'rgb(242,237,215)',
                    borderWidth: 1,
                    yAxisID: 'y',
                },
                {
                    type: 'line',
                    label: `Total`,
                    data: values,
                    borderColor: 'rgb(117,81,57)',
                    backgroundColor: 'rgb(117,81,57)',
                    fill: false,
                    tension: 0.1,
                    pointBackgroundColor: 'rgb(117,81,57)',
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    yAxisID: 'y',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Failures'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Station'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            }
        }
    });
}


function updateTable(row) {
    tbody.innerHTML = `
    <tr>
        <td>${row.workDate}</td>
        <td>${row.vflash1}</td>
        <td>${row.hipot1}</td>
        <td>${row.ats1}</td>
        <td>${row.heatup}</td>
        <td>${row.vibration}</td>
        <td>${row.burnin}</td>
        <td>${row.hipot2}</td>
        <td>${row.ats2}</td>
        <td>${row.vflash2}</td>
        <td>${row.ats3}</td>
        <td>${row.total}</td>
    </tr>
    `;
}

// Event Listeners
lineIdSelect.addEventListener('change', () => {
    startWebSocket(lineIdSelect.value, 'today'); // Always start with 'today' endpoint for summary
});

// Initial load based on URL parameters or default
document.addEventListener('DOMContentLoaded', () => {
    const params = getQueryParams();
    const initialLineId = params.lineId || lineIdSelect.value;

    lineIdSelect.value = initialLineId; // Set dropdown to match URL parameter
    startWebSocket(initialLineId, 'today'); // Connect to 'today' endpoint for summary data
});
</script>

</body>
</html>