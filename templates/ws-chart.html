<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Failures WebSocket</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 20px;
}
#chartContainer {
    width: 80%;
    margin: 20px auto;
}
table {
    margin: 20px auto;
    border-collapse: collapse;
    width: 80%;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px 12px;
    text-align: center;
}
th {
    background-color: #eee;
}
</style>
</head>
<body>

<h2>Failures (WebSocket)</h2>

<label for="lineIdSelect">Select Line ID:</label>
<select id="lineIdSelect">
    <option value="B3">B3</option>
    <option value="BMA01">BMA01</option>
</select>

<div id="chartContainer">
    <canvas id="failuresChart"></canvas>
</div>

<table>
<thead>
<tr>
    <th>Work Date</th>
    <th>VFlash1</th>
    <th>Hipot1</th>
    <th>ATS1</th>
    <th>Heatup</th>
    <th>Burn-in</th>
    <th>Hipot2</th>
    <th>ATS2</th>
    <th>VFlash2</th>
    <th>ATS3</th>
    <th>Total</th>
</tr>
</thead>
<tbody id="resultTableBody">
</tbody>
</table>

<script>
const lineIdSelect = document.getElementById('lineIdSelect');
const ctx = document.getElementById('failuresChart').getContext('2d');
const tbody = document.getElementById('resultTableBody');

let ws = null;
let chart = null;
let currentLineId = lineIdSelect.value; // ‡πÄ‡∏Å‡πá‡∏ö lineId ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ

function startWebSocket(lineId) {
    if (ws) {
        ws.close();
    }
    currentLineId = lineId; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï lineId ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    ws = new WebSocket(`ws://localhost:8000/failures/ws/today?lineId=${lineId}`);

    ws.onopen = () => {
        console.log(`‚úÖ WebSocket opened for lineId=${lineId}`);
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (!data.length) {
            console.warn("‚ö†Ô∏è No data received");
            return;
        }

        updateChart(data[0]);
        updateTable(data[0]);
    };

    ws.onclose = () => {
        console.log("‚ùå WebSocket closed");
    };

    ws.onerror = (err) => {
        console.error("‚ùó WebSocket error:", err);
    };
}

function updateChart(row) {
    const labels = ["VFlash1", "Hipot1", "ATS1", "Heatup", "Burn-in", "Hipot2", "ATS2", "VFlash2", "ATS3"];
    const values = [
        row.vflash1, row.hipot1, row.ats1,
        row.heatup, row.burnin, row.hipot2,
        row.ats2, row.vflash2, row.ats3
    ];

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: `Failures on ${row.workDate}`,
                data: values,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
            }]
        },
        options: {
            responsive: true,
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const firstElement = elements[0];
                    const label = chart.data.labels[firstElement.index];

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà "ATS1"
                    if (label === 'ATS1') {
                        console.log(`Clicked on ${label} for LineID: ${currentLineId}`);
                        // üëá ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏Ñ‡πà lineId
                        navigateToAtsOneDetails(currentLineId); // ‡∏™‡πà‡∏á‡πÅ‡∏Ñ‡πà lineId
                    }
                }
            }
        }
    });
}

function updateTable(row) {
    tbody.innerHTML = `
    <tr>
        <td>${row.workDate}</td>
        <td>${row.vflash1}</td>
        <td>${row.hipot1}</td>
        <td>${row.ats1}</td>
        <td>${row.heatup}</td>
        <td>${row.burnin}</td>
        <td>${row.hipot2}</td>
        <td>${row.ats2}</td>
        <td>${row.vflash2}</td>
        <td>${row.ats3}</td>
        <td>${row.total}</td>
    </tr>
    `;
}

// üëá ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML ‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏Ñ‡πà lineId
function navigateToAtsOneDetails(lineId) {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå HTML ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ ATS1 Detail (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠ ats1_details.html)
    // URL ‡∏à‡∏∞‡∏°‡∏µ‡πÅ‡∏Ñ‡πà lineId ‡πÄ‡∏õ‡πá‡∏ô Query Parameter
    const nextPageUrl = `ats1_details.html?lineId=${lineId}`;

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
    window.location.href = nextPageUrl;
}


lineIdSelect.addEventListener('change', () => {
    const lineId = lineIdSelect.value;
    startWebSocket(lineId);
});

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡πà‡∏≤ default
startWebSocket(lineIdSelect.value);
</script>

</body>
</html>