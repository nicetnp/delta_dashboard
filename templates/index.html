<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BMW Failures Summary</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f4f7f6;
    text-align: center;
    padding: 20px;
}
.container {
    max-width: 90%;
    margin: auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
}
label {
    margin-right: 5px;
}
select, input[type="date"] {
    margin-right: 15px;
    padding: 5px 10px;
}
#chartContainer {
    width: 80%;
    margin: 20px auto;
    position: relative;
    height: 400px;
}
canvas {
    max-width: 100%;
    height: auto;
}

table {
    margin: 20px auto;
    width: 90%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
}
th {
    background: #eee;
}
td.station-clickable {
    cursor: pointer;
}
td.station-clickable:hover {
    background-color: #eef;
}
</style>
</head>
<body>

<div class="container">
    <h2>BMW Failures Summary</h2>

    <label>Line ID:</label>
    <select id="lineIdSelect">
        <option value="BMA01">BMA01</option>
        <option value="B3">B3</option>
    </select>

    <label>Start Date:</label>
    <input type="date" id="startDate" />

    <label>End Date:</label>
    <input type="date" id="endDate" />

    <button id="fixtureButton">Fixture</button>

    <div id="chartContainer">
        <canvas id="failuresChart"></canvas>
    </div>

    <h3>Summary Table</h3>
    <table>
        <thead>
            <tr>
                <th>Work Date</th>
                <th>VFlash1</th>
                <th>Hipot1</th>
                <th>ATS1</th>
                <th>Heatup</th>
                <th>Vibration</th>
                <th>Burn-in</th>
                <th>Hipot2</th>
                <th>ATS2</th>
                <th>VFlash2</th>
                <th>ATS3</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="12">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
const stationColors = {
    'VFlash1': '#e74c3c',
    'Hipot1': '#d4a15e',
    'ATS1': '#c8d96f',
    'Heatup': '#27ae60',
    'Vibration': '#2ecc71',
    'Burn-in': '#1abc9c',
    'Hipot2': '#3498db',
    'ATS2': '#9b59b6',
    'VFlash2': '#bb8fce',
    'ATS3': '#e67ea1'
};

const stationMap = {
    "VFlash1": "%LASH",
    "Hipot1": "%IPOT_1",
    "ATS1": "%TS1",
    "Heatup": "%TUP",
    "Vibration": "%RATION",
    "Burn-in": "%RN_IN",
    "Hipot2": "%IPOT_2",
    "ATS2": "%TS2",
    "VFlash2": "%LASH2",
    "ATS3": "%TS3"
};

const lineIdSelect = document.getElementById('lineIdSelect');
const startDateInput = document.getElementById('startDate');
const endDateInput = document.getElementById('endDate');
const tableBody = document.getElementById('tableBody');
const ctx = document.getElementById('failuresChart').getContext('2d');

let ws = null;
let chart = null;
let currentLineId = lineIdSelect.value;

document.getElementById('fixtureButton').addEventListener('click', () => {
    const lineId = lineIdSelect.value;
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;

    const url = `fixture-detail.html?lineId=${lineId}&startDate=${startDate}&endDate=${endDate}`;
    window.location.href = url;
});

function saveState() {
    sessionStorage.setItem("lineId", lineIdSelect.value);
    sessionStorage.setItem("startDate", startDateInput.value);
    sessionStorage.setItem("endDate", endDateInput.value);
}

function restoreState() {
    const savedLineId = sessionStorage.getItem("lineId");
    const savedStartDate = sessionStorage.getItem("startDate");
    const savedEndDate = sessionStorage.getItem("endDate");
    const today = new Date().toISOString().split('T')[0];

    lineIdSelect.value = savedLineId || "BMA01";
    startDateInput.value = savedStartDate || today;
    endDateInput.value = savedEndDate || today;
}

function navigateToPage(pageName, lineId, stationName, workDate) {
    saveState(); // เก็บสถานะก่อนเปลี่ยนหน้า
    const timestamp = Date.now();
    const url = `${pageName}.html?lineId=${lineId}&station=${encodeURIComponent(stationName)}&workDate=${workDate}&_ts=${timestamp}`;
    window.location.href = url;
}

function reloadData() {
    if (ws) ws.close();

    currentLineId = lineIdSelect.value;
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    const ts = Date.now();

    let wsUrl = `ws://localhost:8000/failures/ws/filter?lineId=${currentLineId}&_ts=${ts}`;
    if (startDate) wsUrl += `&startDate=${startDate}`;
    if (endDate) wsUrl += `&endDate=${endDate}`;

    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        tableBody.innerHTML = `<tr><td colspan="12">Loading...</td></tr>`;
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (!data || data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="12">No data available</td></tr>`;
            if (chart) {
                chart.destroy();
                chart = null;
            }
            return;
        }
        renderChart(data);
        renderTable(data);
    };

    ws.onclose = () => console.log("WebSocket closed.");
    ws.onerror = err => console.error("WebSocket error", err);
}

function renderChart(data) {
    const labels = data.map(row => row.workDate);
    const stationKeys = Object.keys(stationMap);

    const datasets = stationKeys.map(station => ({
        label: station,
        data: data.map(row => row[station.toLowerCase()]),
        backgroundColor: stationColors[station],
        borderColor: stationColors[station],
        borderWidth: 1
    }));

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const element = elements[0];
                    const datasetIndex = element.datasetIndex;
                    const index = element.index;

                    const station = stationKeys[datasetIndex];
                    const mapped = stationMap[station];
                    const workDate = data[index].workDate;

                    if (mapped && workDate) {
                        navigateToPage('station-detail', currentLineId, mapped, workDate);
                    }
                }
            },
            scales: {
                x: { stacked: true, title: { display: true, text: "Date" } },
                y: { stacked: true, beginAtZero: true, title: { display: true, text: "Failures" } }
            }
        }
    });
}

function renderTable(data) {
    tableBody.innerHTML = "";
    data.forEach(row => {
        const workDate = row.workDate;
        tableBody.innerHTML += `
            <tr>
                <td>${workDate}</td>
                ${renderCell(row.vflash1, 'VFlash1', workDate)}
                ${renderCell(row.hipot1, 'Hipot1', workDate)}
                ${renderCell(row.ats1, 'ATS1', workDate)}
                ${renderCell(row.heatup, 'Heatup', workDate)}
                ${renderCell(row.vibration, 'Vibration', workDate)}
                ${renderCell(row.burnin, 'Burn-in', workDate)}
                ${renderCell(row.hipot2, 'Hipot2', workDate)}
                ${renderCell(row.ats2, 'ATS2', workDate)}
                ${renderCell(row.vflash2, 'VFlash2', workDate)}
                ${renderCell(row.ats3, 'ATS3', workDate)}
                <td>${row.total}</td>
            </tr>
        `;
    });
}

// helper function
function renderCell(value, stationKey, workDate) {
    if (value > 0) {
        return `<td class="station-clickable" onclick="navigateToPage('station-detail', '${currentLineId}', '${stationMap[stationKey]}', '${workDate}')">${value}</td>`;
    } else {
        return `<td>${value}</td>`;
    }
}


document.addEventListener("DOMContentLoaded", () => {
    restoreState();
    reloadData();

    lineIdSelect.addEventListener('change', () => {
        saveState();
        reloadData();
    });
    startDateInput.addEventListener('change', () => {
        saveState();
        reloadData();
    });
    endDateInput.addEventListener('change', () => {
        saveState();
        reloadData();
    });
});
</script>

</body>
</html>
